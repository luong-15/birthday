<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday!</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            position: relative;
            z-index: 1;
            background-color: #f0f2f5;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, #ADD8E6, #90EE90, #FFC0CB, #FFFAF0);
            background-size: 400% 400%;
            animation: gradientAnimation 20s ease infinite;
            z-index: -1;
        }

        @keyframes gradientAnimation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        #app-container {
            backdrop-filter: blur(15px);
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 2rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
            animation: fadeInScale 1s ease-out forwards;
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            min-height: 60vh;
            position: relative;
            z-index: 2;
        }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.85); }
            to { opacity: 1; transform: scale(1); }
        }

        #confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 10;
        }

        .confetti {
            position: absolute;
            background-color: #f0f;
            opacity: 0;
            animation: fall 4s forwards ease-out;
        }

        @keyframes fall {
            0% {
                transform: translateY(-100px) rotateZ(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh + 100px)) rotateZ(720deg) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes shake {
            0%, 100% { transform: rotate(0deg); }
            10%, 30%, 50%, 70%, 90% { transform: rotate(-12deg); }
            20%, 40%, 60%, 80% { transform: rotate(12deg); }
        }

        #giftButton:hover .gift-icon-shake {
            animation: shake 0.7s cubic-bezier(.36,.07,.19,.97) both infinite;
            transform-origin: center center;
        }

        #birthday-message {
            background: linear-gradient(135deg, #FFFDE7, #FFFACD);
            border: 5px solid #FFD700;
            border-radius: 30px;
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.5);
            padding: 2.5rem;
            transition: all 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            font-size: 1.25rem;
            line-height: 1.9;
            color: #333;
            text-shadow: 1px 1px 3px rgba(255, 255, 255, 0.6);
            max-width: 95%;
            margin-top: 2.5rem;
            transform: scale(0) translateY(50px);
            opacity: 0;
            will-change: transform, opacity;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        #birthday-message.show {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .avatar-frame {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 6px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin-bottom: 1.5rem;
            overflow: hidden;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .avatar-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        #initialAvatarPromptModal,
        #imageEditorModal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        #initialAvatarPromptModal.show,
        #imageEditorModal.show {
            opacity: 1;
            visibility: visible;
        }

        #initialAvatarPromptModal .modal-content,
        #imageEditorModal .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        #initialAvatarPromptModal.show .modal-content,
        #imageEditorModal.show .modal-content {
            transform: translateY(0);
        }

        #imageEditorCanvas {
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            background-color: #f9f9f9;
            cursor: grab;
            touch-action: none;
        }

        @media (max-width: 768px) {
            #giftButtonInner {
                font-size: 1.1rem;
                padding: 1rem 2rem;
            }
            #app-container {
                padding: 2rem;
            }
            .text-3xl {
                font-size: 2.25rem;
            }
            .text-4xl {
                font-size: 2.5rem;
            }
            #birthday-message {
                font-size: 1.1rem;
                padding: 2rem;
            }
            .avatar-frame {
                width: 100px;
                height: 100px;
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 480px) {
            #giftButtonInner {
                font-size: 0.9rem;
                padding: 0.7rem 1.2rem;
            }
            #app-container {
                padding: 1rem;
            }
            .text-3xl {
                font-size: 1.5rem;
            }
            .text-4xl {
                font-size: 1.75rem;
            }
            #birthday-message {
                font-size: 1rem;
                padding: 1.25rem;
            }
            #randomMessageButton {
                font-size: 0.8rem;
                padding: 0.5rem 1rem;
                bottom: 1rem;
                right: 1rem;
            }
            .avatar-frame {
                width: 80px;
                height: 80px;
                margin-bottom: 0.75rem;
                border-width: 4px;
            }
            #initialAvatarPromptModal .modal-content,
            #imageEditorModal .modal-content {
                padding: 1.5rem;
            }
            #initialAvatarPromptModal h2,
            #imageEditorModal h2 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="font-sans flex items-center justify-center p-4 min-h-screen">
    <main id="app-container" class="relative rounded-3xl text-center mx-auto flex flex-col items-center justify-center">
        <div id="confetti-container" aria-hidden="true"></div>

        <p id="prompt-text" class="text-3xl md:text-4xl text-white mb-10 max-w-prose font-semibold leading-relaxed drop-shadow-lg">
            </p>

        <div class="relative group mb-4" id="giftButtonContainer">
            <button id="giftButton" class="relative inline-block p-px font-semibold leading-6 text-white shadow-2xl cursor-pointer rounded-full shadow-zinc-900 transition-transform duration-300 ease-in-out hover:scale-105 active:scale-95">
                <span class="absolute inset-0 rounded-full bg-gradient-to-r from-pink-500 via-purple-600 to-indigo-700 p-[2px] opacity-0 transition-opacity duration-500 group-hover:opacity-100"></span>
                <span id="giftButtonInner" class="relative z-10 block rounded-full bg-indigo-900 group-hover:bg-indigo-700 transition-colors duration-300 shadow-md hover:shadow-xl">
                    <div class="relative z-10 flex items-center justify-center space-x-2 py-4 px-8 text-xl md:text-2xl">
                        <span class="transition-all duration-500 group-hover:translate-x-1">Open Your Gift</span>
                        <span class="ml-4 text-4xl transition-transform duration-300 group-hover:rotate-[30deg] gift-icon-shake group-hover:translate-x-1">üéÅ</span>
                    </div>
                </span>
            </button>
        </div>

        <input type="file" id="avatarUpload" accept="image/*" class="hidden">

        <section id="birthday-message" class="text-lg md:text-xl hidden" role="region" aria-live="polite">
            </section>

        <button id="randomMessageButton" class="absolute bottom-4 right-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-all duration-300 hidden" style="opacity: 0.02;">
            L·ªùi ch√∫c kh√°c ‚ú®
        </button>
    </main>

    <div id="initialAvatarPromptModal" class="hidden">
        <div class="modal-content text-center">
            <button id="closeInitialAvatarPromptModalButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Th√™m ·∫£nh ƒë·∫°i di·ªán c·ªßa b·∫°n</h2>
            <p class="text-gray-600 mb-6">Nh·∫•n v√†o khung avatar b√™n d∆∞·ªõi ƒë·ªÉ t·∫£i ·∫£nh l√™n.</p>
            <div class="avatar-frame mx-auto relative cursor-pointer group" id="initialAvatarFrame">
                <img id="initialAvatarImg" src="https://placehold.co/120x120/808080/FFFFFF?text=Avatar" alt="Avatar Placeholder" class="w-full h-full object-cover rounded-full">
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-full">
                    <i class="fas fa-camera text-white text-2xl"></i>
                </div>
            </div>
            <p class="text-sm text-gray-500 mt-4">B·∫°n c√≥ th·ªÉ thay ƒë·ªïi ·∫£nh n√†y sau.</p>
        </div>
    </div>

    <div id="imageEditorModal" class="hidden">
        <div class="modal-content">
            <button id="closeImageEditorModalButton" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Ch·ªânh S·ª≠a Avatar</h2>

            <div class="flex flex-col items-center">
                <canvas id="imageEditorCanvas" width="300" height="300" class="rounded-lg mb-4"></canvas>
                <div class="flex space-x-4 mb-6">
                    <button id="zoomInButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                        <i class="fas fa-search-plus"></i> Ph√≥ng to
                    </button>
                    <button id="zoomOutButton" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-full transition-colors duration-200">
                        <i class="fas fa-search-minus"></i> Thu nh·ªè
                    </button>
                </div>
                <button id="applyImageButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-all duration-300 w-full">
                    √Åp d·ª•ng
                </button>
            </div>
        </div>
    </div>

    <audio id="partyHornSound" src="https://cdn.pixabay.com/audio/2024/10/12/audio_65df3f47bb.mp3" preload="auto"></audio>

    <script>
        const giftButtonContainer = document.getElementById('giftButtonContainer');
        const giftButton = document.getElementById('giftButton');
        const birthdayMessage = document.getElementById('birthday-message');
        const confettiContainer = document.getElementById('confetti-container');
        const promptText = document.getElementById('prompt-text');
        const avatarUpload = document.getElementById('avatarUpload');
        const randomMessageButton = document.getElementById('randomMessageButton');

        const initialAvatarPromptModal = document.getElementById('initialAvatarPromptModal');
        const closeInitialAvatarPromptModalButton = document.getElementById('closeInitialAvatarPromptModalButton');
        const initialAvatarFrame = document.getElementById('initialAvatarFrame');
        const initialAvatarImg = document.getElementById('initialAvatarImg');

        const imageEditorModal = document.getElementById('imageEditorModal');
        const closeImageEditorModalButton = document.getElementById('closeImageEditorModalButton');
        const imageEditorCanvas = document.getElementById('imageEditorCanvas');
        const ctx = imageEditorCanvas.getContext('2d');
        const zoomInButton = document.getElementById('zoomInButton');
        const zoomOutButton = document.getElementById('zoomOutButton');
        const applyImageButton = document.getElementById('applyImageButton');

        const partyHornSound = document.getElementById('partyHornSound');

        let currentAvatarUrl = "https://placehold.co/120x120/808080/FFFFFF?text=Avatar";
        let uploadedImage = new Image();
        let scale = 1;
        let offsetX = 0;
        let offsetY = 0;
        let isDragging = false;
        let startX, startY;

        const birthdayMessages = [
            "Ch√∫c m·ª´ng sinh nh·∫≠t! M·ªôt nƒÉm n·ªØa l·∫°i ƒë·∫øn, ch√∫c b·∫°n lu√¥n d·ªìi d√†o s·ª©c kh·ªèe, ng·∫≠p tr√†n ni·ªÅm vui v√† h·∫°nh ph√∫c. Mong r·∫±ng tu·ªïi m·ªõi s·∫Ω mang ƒë·∫øn th·∫≠t nhi·ªÅu c∆° h·ªôi m·ªõi, nh·ªØng th√†nh c√¥ng r·ª±c r·ª° v√† m·ªçi ∆∞·ªõc m∆° ƒë·ªÅu tr·ªü th√†nh hi·ªán th·ª±c. H√£y t·∫≠n h∆∞·ªüng ng√†y ƒë·∫∑c bi·ªát n√†y th·∫≠t tr·ªçn v·∫πn b√™n nh·ªØng ng∆∞·ªùi th√¢n y√™u nh√©! üéâüéÇ‚ú®",
            "Sinh nh·∫≠t vui v·∫ª nh√©! G·ª≠i ƒë·∫øn b·∫°n nh·ªØng l·ªùi ch√∫c t·ªët ƒë·∫πp nh·∫•t trong ng√†y ƒë·∫∑c bi·ªát n√†y. Ch√∫c b·∫°n lu√¥n gi·ªØ v·ªØng n·ª• c∆∞·ªùi tr√™n m√¥i, tr√°i tim lu√¥n ·∫•m √°p v√† t√¢m h·ªìn lu√¥n tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng t√≠ch c·ª±c. H√£y bi·∫øn m·ªçi kh√≥ khƒÉn th√†nh ƒë·ªông l·ª±c v√† s·ªëng m·ªói ng√†y th·∫≠t √Ω nghƒ©a. Happy Birthday! üéàüíñüåü",
            "G·ª≠i nh·ªØng l·ªùi ch√∫c ch√¢n th√†nh nh·∫•t ƒë·∫øn b·∫°n trong ng√†y sinh nh·∫≠t! Ch√∫c b·∫°n m·ªôt tu·ªïi m·ªõi tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng, nhi·ªát huy·∫øt, g·∫∑t h√°i ƒë∆∞·ª£c nhi·ªÅu th√†nh c√¥ng h∆°n n·ªØa tr√™n con ƒë∆∞·ªùng m√¨nh ƒë√£ ch·ªçn. Mong b·∫°n lu√¥n ƒë∆∞·ª£c y√™u th∆∞∆°ng, bao b·ªçc v√† c√≥ nh·ªØng kho·∫£nh kh·∫Øc ƒë√°ng nh·ªõ trong cu·ªôc s·ªëng. ü•≥üéÅüçÄ",
            "Ch√∫c m·ª´ng sinh nh·∫≠t! Hy v·ªçng h√¥m nay l√† m·ªôt ng√†y ng·∫≠p tr√†n ti·∫øng c∆∞·ªùi, t√¨nh y√™u v√† nh·ªØng b·∫•t ng·ªù th√∫ v·ªã. Ch√∫c b·∫°n lu√¥n m·∫°nh kh·ªèe, b√¨nh an, h·∫°nh ph√∫c v√† may m·∫Øn trong m·ªçi vi·ªác. C·∫ßu mong m·ªçi ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t s·∫Ω ƒë·∫øn v·ªõi b·∫°n trong tu·ªïi m·ªõi. ‚ù§Ô∏èüòäüåª",
            "M·ªôt nƒÉm n·ªØa tr√¥i qua, v√† b·∫°n l·∫°i th√™m m·ªôt tu·ªïi. Ch√∫c m·ª´ng sinh nh·∫≠t! Ch√∫c b·∫°n lu√¥n tr·∫ª trung, nƒÉng ƒë·ªông, gi·ªØ v·ªØng ƒëam m√™ v√† nhi·ªát huy·∫øt ƒë·ªÉ chinh ph·ª•c m·ªçi th·ª≠ th√°ch. H√£y lu√¥n l√† ch√≠nh m√¨nh, t·ªèa s√°ng theo c√°ch ri√™ng v√† ƒë·ª´ng qu√™n t·∫≠n h∆∞·ªüng t·ª´ng kho·∫£nh kh·∫Øc c·ªßa cu·ªôc s·ªëng. üéäü•Çüåà",
            "Sinh nh·∫≠t an l√†nh v√† h·∫°nh ph√∫c b√™n gia ƒë√¨nh, b·∫°n b√® nh√©! Ch√∫c b·∫°n c√≥ m·ªôt ng√†y k·ª∑ ni·ªám th·∫≠t ·∫•m √°p, √Ω nghƒ©a v√† kh√≥ qu√™n. Mong r·∫±ng tu·ªïi m·ªõi s·∫Ω mang ƒë·∫øn cho b·∫°n th·∫≠t nhi·ªÅu ni·ªÅm vui, s·ª± th·ªãnh v∆∞·ª£ng v√† nh·ªØng ƒëi·ªÅu k·ª≥ di·ªáu. Lu√¥n y√™u ƒë·ªùi v√† s·ªëng th·∫≠t tr·ªçn v·∫πn nh√©! ü§óüè°üéâ",
            "Ch√∫c m·ª´ng sinh nh·∫≠t ng∆∞·ªùi b·∫°n tuy·ªát v·ªùi! Lu√¥n gi·ªØ n·ª• c∆∞·ªùi tr√™n m√¥i, v√¨ n·ª• c∆∞·ªùi c·ªßa b·∫°n mang l·∫°i √°nh s√°ng cho m·ªçi ng∆∞·ªùi xung quanh. Ch√∫c b·∫°n lu√¥n t√¨m th·∫•y ni·ªÅm vui trong nh·ªØng ƒëi·ªÅu nh·ªè b√©, lu√¥n ƒë∆∞·ª£c y√™u th∆∞∆°ng v√† tr√¢n tr·ªçng. Happy B-day! ü•∞‚ú®üíñ",
            "Tu·ªïi m·ªõi th·∫≠t nhi·ªÅu may m·∫Øn v√† th√†nh c√¥ng r·ª±c r·ª°! Ch√∫c m·ª´ng sinh nh·∫≠t! H√£y t·ª± tin b∆∞·ªõc ƒëi tr√™n con ƒë∆∞·ªùng m√¨nh ƒë√£ ch·ªçn, kh√¥ng ng·ª´ng h·ªçc h·ªèi v√† ph√°t tri·ªÉn b·∫£n th√¢n. M·ªçi c·ªë g·∫Øng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ƒë·ªÅn ƒë√°p x·ª©ng ƒë√°ng. Ch√∫c b·∫°n m·ªôt nƒÉm m·ªõi tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng v√† ƒë·ªôt ph√°! üí™üåüüöÄ",
            "H√£y t·∫≠n h∆∞·ªüng ng√†y sinh nh·∫≠t th·∫≠t ƒë√°ng nh·ªõ nh√©! Ch√∫c b·∫°n c√≥ m·ªôt b·ªØa ti·ªác th·∫≠t vui v·∫ª, ·∫•m c√∫ng v√† tr√†n ng·∫≠p h·∫°nh ph√∫c b√™n nh·ªØng ng∆∞·ªùi th√¢n y√™u. Mong r·∫±ng b·∫°n s·∫Ω lu√¥n ƒë∆∞·ª£c bao b·ªçc b·ªüi t√¨nh y√™u th∆∞∆°ng, s·ª± quan t√¢m v√† nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t. Ch√∫c m·ª´ng sinh nh·∫≠t! üéÇüéàü•≥",
            "Ch√∫c b·∫°n c√≥ m·ªôt ng√†y sinh nh·∫≠t th·∫≠t √Ω nghƒ©a v√† ·∫•m √°p. Ch√∫c m·ª´ng sinh nh·∫≠t! Mong r·∫±ng m·ªçi ƒëi·ªÅu ∆∞·ªõc c·ªßa b·∫°n trong ng√†y h√¥m nay s·∫Ω s·ªõm tr·ªü th√†nh hi·ªán th·ª±c. H√£y lu√¥n s·ªëng v·ªõi ni·ªÅm ƒëam m√™, ho√†i b√£o v√† kh√¥ng ng·ª´ng v∆∞∆°n t·ªõi nh·ªØng ƒë·ªânh cao m·ªõi. Happy Birthday!üí´üíñüåü"
        ];

        function playPartyHornSound() {
            if (partyHornSound) {
                partyHornSound.currentTime = 0;
                partyHornSound.play().catch(error => {
                    let errorMessage = "L·ªói kh√¥ng x√°c ƒë·ªãnh khi ph√°t √¢m thanh k√®n party horn.";
                    if (error && error.name) {
                        errorMessage = `L·ªói khi ph√°t √¢m thanh k√®n party horn: ${error.name}`;
                        if (error.message) {
                            errorMessage += ` - ${error.message}`;
                        }
                    } else if (error) {
                        errorMessage = `L·ªói khi ph√°t √¢m thanh k√®n party horn: ${JSON.stringify(error)}`;
                    }
                    console.error(errorMessage);

                    if (error && error.name === 'NotAllowedError') {
                        console.warn("Tr√¨nh duy·ªát c√≥ th·ªÉ ƒë√£ ch·∫∑n t·ª± ƒë·ªông ph√°t √¢m thanh. Vui l√≤ng t∆∞∆°ng t√°c v·ªõi trang ƒë·ªÉ cho ph√©p √¢m thanh.");
                    }
                });
            }
        }

        function createConfetti() {
            const colors = [
                '#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4',
                '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107',
                '#FF9800', '#FF5722', '#FFD700', '#ADFF2F', '#00FFFF', '#FF69B4'
            ];
            const shapes = ['50%', '0'];
            const numConfetti = 150;

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = Math.random() * -20 + 'vh';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDuration = (Math.random() * 3 + 4) + 's';
                confetti.style.animationDelay = (Math.random() * 1.5) + 's';
                const size = (Math.random() * 10 + 6) + 'px';
                confetti.style.width = size;
                confetti.style.height = size;
                confetti.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)];
                confetti.style.transform = `rotateZ(${Math.random() * 360}deg)`;
                confettiContainer.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
            playPartyHornSound();
        }

        function drawAvatarOnCanvas() {
            ctx.clearRect(0, 0, imageEditorCanvas.width, imageEditorCanvas.height);
            if (uploadedImage.src) {
                ctx.save();

                ctx.beginPath();
                ctx.arc(imageEditorCanvas.width / 2, imageEditorCanvas.height / 2, Math.min(imageEditorCanvas.width, imageEditorCanvas.height) / 2, 0, Math.PI * 2);
                ctx.clip();

                const imgWidth = uploadedImage.width * scale;
                const imgHeight = uploadedImage.height * scale;
                const x = offsetX + (imageEditorCanvas.width - imgWidth) / 2;
                const y = offsetY + (imageEditorCanvas.height - imgHeight) / 2;

                ctx.drawImage(uploadedImage, x, y, imgWidth, imgHeight);

                ctx.restore();
            }
        }

        function displayMessage(message) {
            let avatarDiv = document.getElementById('avatarFrame');
            let avatarImg = document.getElementById('currentAvatarImg');

            if (!avatarDiv) {
                avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar-frame', 'relative', 'cursor-pointer', 'group');
                avatarDiv.id = 'avatarFrame';

                avatarImg = document.createElement('img');
                avatarImg.id = 'currentAvatarImg';
                avatarImg.alt = "Avatar";
                avatarImg.onerror = function() { this.src = 'https://placehold.co/120x120/808080/FFFFFF?text=Error'; };
                avatarDiv.appendChild(avatarImg);

                const overlayDiv = document.createElement('div');
                overlayDiv.classList.add('absolute', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-black', 'bg-opacity-50', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity', 'duration-300', 'rounded-full');
                const cameraIcon = document.createElement('i');
                cameraIcon.classList.add('fas', 'fa-camera', 'text-white', 'text-2xl');
                overlayDiv.appendChild(cameraIcon);
                avatarDiv.appendChild(overlayDiv);

                avatarDiv.addEventListener('click', () => {
                    avatarUpload.click();
                });

                birthdayMessage.prepend(avatarDiv);
            }

            avatarImg.src = currentAvatarUrl;

            let messageContentContainer = birthdayMessage.querySelector('.message-content-container');
            if (!messageContentContainer) {
                messageContentContainer = document.createElement('div');
                messageContentContainer.classList.add('message-content-container');
                birthdayMessage.appendChild(messageContentContainer);
            }

            messageContentContainer.innerHTML = `<p class="font-pacifico text-3xl md:text-4xl leading-tight mb-4 text-yellow-800">Happy Birthday!üéâ</p><p>${message}</p>`;

            birthdayMessage.classList.remove('hidden');
            requestAnimationFrame(() => birthdayMessage.classList.add('show'));
        }

        function displayRandomMessage() {
            const randomIndex = Math.floor(Math.random() * birthdayMessages.length);
            displayMessage(birthdayMessages[randomIndex]);
        }

        function saveAvatarToLocalStorage(avatarDataUrl) {
            try {
                localStorage.setItem('userAvatar', avatarDataUrl);
                console.log('Avatar saved to localStorage.');
            } catch (e) {
                console.error('Error saving avatar to localStorage:', e);
            }
        }

        function loadAvatarFromLocalStorage() {
            const savedAvatar = localStorage.getItem('userAvatar');
            if (savedAvatar) {
                currentAvatarUrl = savedAvatar;
                console.log('Avatar loaded from localStorage.');
            } else {
                console.log('No avatar found in localStorage, using default.');
            }
        }

        function initializeDisplay() {
            loadAvatarFromLocalStorage();

            if (localStorage.getItem('userAvatar')) {
                giftButtonContainer.style.display = 'none';
                promptText.textContent = 'üéäüéäüéä';
                displayRandomMessage();
                randomMessageButton.classList.remove('hidden');
            } else {
                giftButtonContainer.style.display = 'block';
                promptText.textContent = 'H√£y nh·∫•n v√†o h·ªôp qu√† ƒë·ªÉ t·∫°o b·∫•t ng·ªù nh√©! ‚ú®';
                birthdayMessage.classList.add('hidden');
                randomMessageButton.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeDisplay);

        giftButton.addEventListener('click', () => {
            if (!localStorage.getItem('userAvatar')) {
                giftButtonContainer.style.display = 'none';
                promptText.textContent = 'H√£y t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán c·ªßa b·∫°n! ‚ú®';
                initialAvatarPromptModal.classList.add('show');
            } else {
                giftButtonContainer.style.display = 'none';
                promptText.textContent = 'üéäüéäüéä';
                displayRandomMessage();
                randomMessageButton.classList.remove('hidden');
                createConfetti();
            }
        });

        randomMessageButton.addEventListener('click', () => {
            displayRandomMessage();
        });

        initialAvatarFrame.addEventListener('click', () => {
            avatarUpload.click();
        });

        closeInitialAvatarPromptModalButton.addEventListener('click', () => {
            initialAvatarPromptModal.classList.remove('show');
            if (!localStorage.getItem('userAvatar')) {
                giftButtonContainer.style.display = 'block';
                promptText.textContent = 'H√£y nh·∫•n v√†o h·ªôp qu√† ƒë·ªÉ t·∫°o b·∫•t ng·ªù nh√©! ‚ú®';
            }
        });

        avatarUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage.src = e.target.result;
                    uploadedImage.onload = () => {
                        scale = Math.max(imageEditorCanvas.width / uploadedImage.width, imageEditorCanvas.height / uploadedImage.height);
                        offsetX = 0;
                        offsetY = 0;
                        drawAvatarOnCanvas();
                        initialAvatarPromptModal.classList.remove('show');
                        imageEditorModal.classList.add('show');
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        closeImageEditorModalButton.addEventListener('click', () => {
            imageEditorModal.classList.remove('show');
            if (!localStorage.getItem('userAvatar')) {
                initialAvatarPromptModal.classList.add('show');
            }
        });

        zoomInButton.addEventListener('click', () => {
            scale *= 1.1;
            drawAvatarOnCanvas();
        });

        zoomOutButton.addEventListener('click', () => {
            scale /= 1.1;
            drawAvatarOnCanvas();
        });

        applyImageButton.addEventListener('click', () => {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            const size = 120;
            tempCanvas.width = size;
            tempCanvas.height = size;

            tempCtx.beginPath();
            tempCtx.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2);
            tempCtx.clip();

            const imgWidth = uploadedImage.width * scale;
            const imgHeight = uploadedImage.height * scale;

            const x = offsetX + (imageEditorCanvas.width - imgWidth) / 2;
            const y = offsetY + (imageEditorCanvas.height - imgHeight) / 2;

            const ratio = size / imageEditorCanvas.width;
            tempCtx.drawImage(uploadedImage, x * ratio, y * ratio, imgWidth * ratio, imgHeight * ratio);

            currentAvatarUrl = tempCanvas.toDataURL('image/png');
            const existingAvatarImg = document.getElementById('currentAvatarImg');
            if (existingAvatarImg) {
                existingAvatarImg.src = currentAvatarUrl;
            }
            saveAvatarToLocalStorage(currentAvatarUrl);
            imageEditorModal.classList.remove('show');

            if (promptText.textContent === 'H√£y t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán c·ªßa b·∫°n! ‚ú®') {
                promptText.textContent = 'üéäüéäüéä';
                displayRandomMessage();
                randomMessageButton.classList.remove('hidden');
                createConfetti();
            }
        });

        imageEditorCanvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            imageEditorCanvas.style.cursor = 'grabbing';
        });

        imageEditorCanvas.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            offsetX += dx;
            offsetY += dy;
            startX = e.clientX;
            startY = e.clientY;
            drawAvatarOnCanvas();
        });

        imageEditorCanvas.addEventListener('mouseup', () => {
            isDragging = false;
            imageEditorCanvas.style.cursor = 'grab';
        });

        imageEditorCanvas.addEventListener('mouseleave', () => {
            isDragging = false;
            imageEditorCanvas.style.cursor = 'grab';
        });

        imageEditorCanvas.addEventListener('touchstart', (e) => {
            isDragging = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            imageEditorCanvas.style.cursor = 'grabbing';
        }, { passive: false });

        imageEditorCanvas.addEventListener('touchmove', (e) => {
            if (!isDragging) return;
            const dx = e.touches[0].clientX - startX;
            const dy = e.touches[0].clientY - startY;
            offsetX += dx;
            offsetY += dy;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            drawAvatarOnCanvas();
            e.preventDefault();
        }, { passive: false });

        imageEditorCanvas.addEventListener('touchend', () => {
            isDragging = false;
            imageEditorCanvas.style.cursor = 'grab';
        });
    </script>
</body>
</html>
